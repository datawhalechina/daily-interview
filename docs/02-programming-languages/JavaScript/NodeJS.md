# æ ¡æ‹›å‰ç«¯é¢è¯•å¸¸è§é—®é¢˜ã€?ã€‘â€”â€”NodeJS

## NodeJS

#### Qï¼šNodeJS çš?IO æ¨¡å‹ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿä¸å¤šçº¿ç¨‹åŒæ­¥ IO æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

NodeJS çš?IO æ¨¡å‹ï¼ˆæ›´å‡†ç¡®çš„è¯´æ˜?js çš„æ‰§è¡Œç¯å¢ƒï¼Œä¹Ÿå°±æ˜?v8ï¼‰çš„ç‰¹ç‚¹æ˜¯â€œå•çº¿ç¨‹å¼‚æ­¥éé˜»å¡â€ã€?

è€Œä¸å¤šçº¿ç¨‹åŒæ­?IOï¼Œä¸¤è€…å„æœ‰ä¼˜åŠ£ï¼Œåº”è¯¥æ ¹æ®å®é™…åº”ç”¨åœºæ™¯æ¥åšå–èˆã€?

åœ¨ä¼ ç»Ÿçš„è§‚ç‚¹é‡Œï¼Œå¼‚æ­¥ IO çš„å¥½å¤„æ˜¯ IO æœ¬èº«å¹¶ä¸éœ€è¦å ç”¨å¤ªå¤šçš„èµ„æºï¼Œç¼ºç‚¹åœ¨äºéçº¿æ€§ä»£ç å¸¦æ¥çš„å¤æ‚åº¦å’Œéš¾ä»¥ç†è§£ç»´æŠ¤ï¼Œè€Œå¤šçº¿ç¨‹åŒæ­¥ IO çš„ç¼ºç‚¹åœ¨äºæ€§èƒ½èµ„æºçš„å¼€é”€å’Œçº¿ç¨‹ç®¡ç†çš„é—®é¢˜ã€?

æ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼Œåœ¨ç›¸åŒçš„æœºå™¨èµ„æºé‡Œé¢ï¼Œå¼‚æ­¥ IO çš„å¹¶å‘é‡è‚¯å®šæ˜¯è¦é«˜äºå¤šçº¿ç¨‹åŒæ­?IO çš„ï¼›ä½†æ˜¯æœåŠ¡å™¨ç¨‹åºæœ¬èº«è‚¯å®šä¸åªæ˜¯ç”?IO ç»„æˆï¼Œè¿˜æœ‰é€»è¾‘è¿ç®—çš„éƒ¨åˆ†ï¼Œè¿‡é‡çš„é€»è¾‘è¿ç®—ä¾æ—§ä¼šå½±å“æ€§èƒ½ã€‚æ¢å¥è¯è¯´ï¼Œå¯†é›†å?CPU ä»»åŠ¡ä¼šé˜»å¡?js çš„æ‰§è¡Œï¼Œå¯¼è‡´å¼‚æ­¥ IO å¾—ä¸åˆ°å¤„ç†ï¼Œæå¤§åœ°å½±å“åˆ° node å¤„ç†å“åº”çš„æ—¶é—´ã€?

æ€»ä¹‹ï¼Œnode çš?IO æ¨¡å‹æ›´é€‚åˆå¤„ç† IO å¯†é›†å‹çš„ä»»åŠ¡ã€‚å¤šçº¿ç¨‹åŒæ­¥ IO æ›´é€‚åˆå¤„ç†è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ã€?

#### Qï¼šV8 å¼•æ“åƒåœ¾å›æ”¶æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

1ã€å¦‚ä½•åˆ¤æ–­æ˜¯å¦å¯ä»¥å›æ”?
ï¼?ï¼‰æ ‡è®°æ¸…é™?
å½“å˜é‡è¿›å…¥ç¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œåœ¨å‡½æ•°ä¸­å£°æ˜ä¸€ä¸ªå˜é‡ï¼‰æ—¶ï¼Œå°±å°†è¿™ä¸ªå˜é‡æ ‡è®°ä¸ºâ€œè¿›å…¥ç¯å¢ƒâ€ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œæ°¸è¿œä¸èƒ½é‡Šæ”¾è¿›å…¥ç¯å¢ƒçš„å˜é‡æ‰€å ç”¨çš„å†…å­˜ï¼Œå› ä¸ºåªè¦æ‰§è¡Œæµè¿›å…¥ç›¸åº”çš„ç¯å¢ƒï¼Œå°±å¯èƒ½ä¼šç”¨åˆ°å®ƒä»¬ã€‚è€Œå½“å˜é‡ç¦»å¼€ç¯å¢ƒæ—¶ï¼Œåˆ™å°†å…¶æ ‡è®°ä¸ºâ€œç¦»å¼€ç¯å¢ƒâ€ã€?

å…·ä½“åšæ³•ï¼?
åƒåœ¾æ”¶é›†å™¨åœ¨è¿è¡Œçš„æ—¶å€™ä¼šç»™å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ‰€æœ‰å˜é‡éƒ½åŠ ä¸Šæ ‡è®°ï¼ˆå½“ç„¶ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•æ ‡è®°æ–¹å¼ï¼‰ã€?
ç„¶åï¼Œå®ƒä¼šå»æ‰è¿è¡Œç¯å¢ƒä¸­çš„å˜é‡ä»¥åŠè¢«ç¯å¢ƒä¸­å˜é‡æ‰€å¼•ç”¨çš„å˜é‡çš„æ ‡è®°
æ­¤åï¼Œä¾ç„¶æœ‰æ ‡è®°çš„å˜é‡å°±è¢«è§†ä¸ºå‡†å¤‡åˆ é™¤çš„å˜é‡ï¼ŒåŸå› æ˜¯åœ¨è¿è¡Œç¯å¢ƒä¸­å·²ç»æ— æ³•è®¿é—®åˆ°è¿™äº›å˜é‡äº†ã€?
æœ€åï¼Œåƒåœ¾æ”¶é›†å™¨å®Œæˆå†…å­˜æ¸…é™¤å·¥ä½œï¼Œé”€æ¯é‚£äº›å¸¦æ ‡è®°çš„å€¼å¹¶å›æ”¶å®ƒä»¬æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ã€?

ï¼?ï¼‰å¼•ç”¨è®¡æ•?
å¼•ç”¨è®¡æ•°çš„å«ä¹‰æ˜¯è·Ÿè¸ªè®°å½•æ¯ä¸ªå€¼è¢«å¼•ç”¨çš„æ¬¡æ•°ã€?
å½“å£°æ˜äº†ä¸€ä¸ªå˜é‡å¹¶å°†ä¸€ä¸ªå¼•ç”¨ç±»å‹å€¼èµ‹ç»™è¯¥å˜é‡æ—¶ï¼Œåˆ™è¿™ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°å°±æ˜¯ 1ã€?
å¦‚æœåŒä¸€ä¸ªå€¼åˆè¢«èµ‹ç»™å¦ä¸€ä¸ªå˜é‡ï¼Œåˆ™è¯¥å€¼çš„å¼•ç”¨æ¬¡æ•°åŠ?1ã€?
ç›¸åï¼Œå¦‚æœåŒ…å«å¯¹è¿™ä¸ªå€¼å¼•ç”¨çš„å˜é‡åˆå–å¾—äº†å¦å¤–ä¸€ä¸ªå€¼ï¼Œåˆ™è¿™ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°å‡?1ã€?
å½“è¿™ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°å˜æˆ 0 æ—¶ï¼Œå°±å¯ä»¥å°†å…¶å ç”¨çš„å†…å­˜ç©ºé—´å›æ”¶å›æ¥ï¼Œè¿™æ ·ï¼Œå½“åƒåœ¾æ”¶é›†å™¨ä¸‹æ¬¡å†è¿è¡Œæ—¶ï¼Œå®ƒå°±ä¼šé‡Šæ”¾é‚?äº›å¼•ç”¨æ¬¡æ•°ä¸ºé›¶çš„å€¼æ‰€å ç”¨çš„å†…å­˜ã€?
ä½†è¿™æ ·ä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€?

2ã€V8 åƒåœ¾å›æ”¶ç­–ç•¥
å°†å†…å­˜åˆ†ä¸ºä¸¤ä¸ªç”Ÿä»£ï¼šæ–°ç”Ÿä»£ï¼ˆnew generationï¼‰å’Œè€ç”Ÿä»£ï¼ˆold generationï¼‰ã€?
æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒé•¿æˆ–å¸¸é©»å†…å­˜çš„å¯¹è±¡ï¼Œåˆ†åˆ«å¯¹æ–°è€ç”Ÿä»£é‡‡ç”¨ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•æ¥æé«˜æ•ˆç‡ï¼Œå¯¹è±¡æœ€å¼€å§‹éƒ½ä¼šå…ˆè¢«åˆ†é…åˆ°æ–°ç”Ÿä»£ï¼ˆå¦‚æœæ–°ç”Ÿä»£å†…å­˜ç©ºé—´ä¸å¤Ÿï¼Œç›´æ¥åˆ†é…åˆ°è€ç”Ÿä»£ï¼‰ï¼Œæ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¼šåœ¨æ»¡è¶³æŸäº›æ¡ä»¶åï¼Œæ™‹å‡åˆ°è€ç”Ÿä»£ã€?

æ–°ç”Ÿä»£ä¸»è¦ä½¿ç”?Scavenge è¿›è¡Œç®¡ç†ï¼Œå°†å†…å­˜å¹³å‡åˆ†ä¸ºä¸¤å—ï¼Œä½¿ç”¨ç©ºé—´å« Fromï¼Œé—²ç½®ç©ºé—´å« Toï¼Œæ–°å¯¹è±¡éƒ½å…ˆåˆ†é…åˆ?From ç©ºé—´ä¸­ï¼Œåœ¨ç©ºé—´å¿«è¦å æ»¡æ—¶å°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° To ç©ºé—´ä¸­ï¼Œç„¶åæ¸…ç©º From çš„å†…å­˜ç©ºé—´ï¼Œæ­¤æ—¶ï¼Œè°ƒæ?From ç©ºé—´å’?To ç©ºé—´ï¼Œç»§ç»­è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå½“æ»¡è¶³æ™‹å‡æ¡ä»¶æ—¶å¯¹è±¡ä¼šä»æ–°ç”Ÿä»£æ™‹å‡åˆ°è€ç”Ÿä»£ã€?

å¯¹è±¡æ™‹å‡çš„æ¡ä»¶ä¸»è¦æœ‰ä¸¤ä¸ªï¼?
å¦‚æœä¸€ä¸ªå¯¹è±¡æ˜¯ç¬¬äºŒæ¬¡ç»å†ä» From ç©ºé—´å¤åˆ¶åˆ?To ç©ºé—´ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šè¢«ç§»åŠ¨åˆ°è€ç”Ÿä»£ä¸­ã€?
å½“è¦ä»?From ç©ºé—´å¤åˆ¶ä¸€ä¸ªå¯¹è±¡åˆ° To ç©ºé—´æ—¶ï¼Œå¦‚æœ To ç©ºé—´å·²ç»ä½¿ç”¨äº†è¶…è¿?25%ï¼Œåˆ™è¿™ä¸ªå¯¹è±¡ç›´æ¥æ™‹å‡åˆ°è€ç”Ÿä»£ä¸­ã€‚ï¼ˆè®¾ç½® 25%è¿™ä¸ªé˜ˆå€¼çš„åŸå› æ˜¯å½“è¿™æ¬¡ Scavenge å›æ”¶å®Œæˆåï¼Œè¿™ä¸ª To ç©ºé—´ä¼šå˜ä¸?From ç©ºé—´ï¼Œæ¥ä¸‹æ¥çš„å†…å­˜åˆ†é…å°†åœ¨è¿™ä¸ªç©ºé—´ä¸­è¿›è¡Œã€‚å¦‚æœå æ¯”è¿‡é«˜ï¼Œä¼šå½±å“åç»­çš„å†…å­˜åˆ†é…ï¼?

è€ç”Ÿä»£ä¸»è¦é‡‡ç”?Mark-Sweep å’?Mark-Compact ç®—æ³•ï¼Œä¸€ä¸ªæ˜¯æ ‡è®°æ¸…é™¤ï¼Œä¸€ä¸ªæ˜¯æ ‡è®°æ•´ç†ã€‚ä¸¤è€…ä¸åŒçš„åœ°æ–¹æ˜¯ï¼ŒMark-Sweep åœ¨åƒåœ¾å›æ”¶åä¼šäº§ç”Ÿç¢ç‰‡å†…å­˜ï¼Œè€?Mark-Compact åœ¨æ¸…é™¤å‰ä¼šè¿›è¡Œä¸€æ­¥æ•´ç†ï¼Œå°†å­˜æ´»å¯¹è±¡å‘ä¸€ä¾§ç§»åŠ¨ï¼Œéšåæ¸…ç©ºè¾¹ç•Œçš„å¦ä¸€ä¾§å†…å­˜ï¼Œè¿™æ ·ç©ºé—²çš„å†…å­˜éƒ½æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å¸¦æ¥çš„é—®é¢˜å°±æ˜¯é€Ÿåº¦ä¼šæ…¢ä¸€äº›ã€‚åœ¨ V8 ä¸­ï¼Œè€ç”Ÿä»£æ˜¯ Mark-Sweep å’?Mark-Compact ä¸¤è€…å…±åŒè¿›è¡Œç®¡ç†çš„ã€?

#### Qï¼šå®ç°ä¸€ä¸?EventEmitterï¼?

å®ç°ï¼?

```javascript
class EventEmitter {
  constructor() {
    this._events = {}
  }

  subscribe(type, handler) {
    if (this._events.hasOwnProperty(type)) {
      this._events[type].push(handler)
    } else {
      this._events[type] = [handler]
    }
  }

  unsubscribe(type, handler) {
    if (this._events.hasOwnProperty(type)) {
      const index = this._events[type].indexOf(handler)
      if (index > -1) {
        this._events[type].splice(index, 1)
      }
    }
  }

  once(type, handler) {
    let fired = false
    let _this = this
    function magic() {
      _this.unsubscribe(type, magic)

      if (!fired) {
        fired = true
        handler.apply(_this, arguments)
      }
    }
    this.subscribe(type, magic)
  }

  emit(type, args) {
    if (this._events.hasOwnProperty(type)) {
      this._events[type].forEach((fn) => fn(args))
    }
  }
}

module.exports = EventEmitter
```

ä½¿ç”¨ï¼?

```javascript
const EventEmitter = require('./myEventEmitter')

const eventEmitter = new EventEmitter()

const fn = (args) => {
  console.log('good args', args)
}
const fn2 = (args) => {
  console.log('good args 2', args)
}
const fn3 = (args) => {
  console.log('good args 3', args)
}

eventEmitter.subscribe('good', fn)
eventEmitter.subscribe('good2', fn2)

eventEmitter.emit('good', 11111)
eventEmitter.emit('good2', 22222)

eventEmitter.unsubscribe('good', fn)

eventEmitter.emit('good2', 22222)

eventEmitter.once('good3', fn3)
eventEmitter.emit('good3', 33333)

eventEmitter.emit('good3', 33333)
```

#### Qï¼šes6 æ¨¡å—åŒ–ã€commonjs æ¨¡å—åŒ–çš„åŒºåˆ«ï¼?

es6 æ¨¡å—åŒ–ï¼š

```
åœ¨es6è§„èŒƒä¸­ï¼Œä½¿ç”¨importå’Œexportå¯ä»¥ä½¿jsæ–‡ä»¶æ¨¡å—åŒ–ã€?
æ¯ä¸ªimportçš„jsæ–‡ä»¶éƒ½æ˜¯å•ä¾‹ï¼Œå¦‚æœå†æ¬¡importï¼Œå°±ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œè¯»å–ã€?

å¯¼å‡ºæ–¹å¼1ï¼?
//lib.js æ–‡ä»¶
let foo = "stringFoo";
let fn0 = function() {
    console.log("fn0");
};
export{foo, fn}

//main.jsæ–‡ä»¶
import {foo, fn} from "./lib";
console.log(bar+"_"+foo);

```

commonjs æ¨¡å—åŒ–ï¼š

```
Node åº”ç”¨ç”±æ¨¡å—ç»„æˆï¼Œé‡‡ç”¨ CommonJS æ¨¡å—è§„èŒƒã€?

æ¯ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œæœ‰è‡ªå·±çš„ä½œç”¨åŸŸã€‚åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰çš„å˜é‡ã€å‡½æ•°ã€ç±»ï¼Œéƒ½æ˜¯ç§æœ‰çš„ï¼Œå¯¹å…¶ä»–æ–‡ä»¶ä¸å¯è§ã€‚å¦‚æœè¦å®šä¹‰å…¨å±€å˜é‡ï¼Œéœ€è¦globalå±æ€§ã€?

CommonJSè§„èŒƒè§„å®šï¼Œæ¯ä¸ªæ¨¡å—å†…éƒ¨ï¼Œmoduleå˜é‡ä»£è¡¨å½“å‰æ¨¡å—ã€?
è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„exportså±æ€§ï¼ˆå³module.exportsï¼‰æ˜¯å¯¹å¤–çš„æ¥å£ã€‚åŠ è½½æŸä¸ªæ¨¡å—ï¼Œå…¶å®æ˜¯åŠ è½½è¯¥æ¨¡å—çš„module.exportså±æ€§ã€?
ä¸ºäº†æ–¹ä¾¿ï¼ŒNodeä¸ºæ¯ä¸ªæ¨¡å—æä¾›ä¸€ä¸ªexportså˜é‡ï¼ŒæŒ‡å‘module.exportsã€?

ä¾‹å¦‚ï¼?
var test = function () {
	console.log(123);
};
module.exports.test = test;

ä½¿ç”¨require('XXX')åŠ è½½æ¨¡å—ã€?
requireå‘½ä»¤çš„åŸºæœ¬åŠŸèƒ½æ˜¯ï¼Œè¯»å…¥å¹¶æ‰§è¡Œä¸€ä¸ªJavaScriptæ–‡ä»¶ï¼Œç„¶åè¿”å›è¯¥æ¨¡å—çš„exportså¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å‘ç°æŒ‡å®šæ¨¡å—ï¼Œä¼šæŠ¥é”™ã€?
```

## NodeJS ç›¸å…³æ¡†æ¶

#### Qï¼šè¯·ç®€è¿°ä¸€ä¸?Koa çš„æ´‹è‘±æ¨¡å‹ï¼Ÿ

koa æ´‹è‘±æ¨¡å‹æ˜¯æŒ‡ koa ä¸­æ¯ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåºã€?
koa åœ¨æ‰§è¡Œå¤šä¸ªä¸­é—´ä»¶ä¸­çš„é€»è¾‘æ—¶ï¼Œä¼šå…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶çš„é€»è¾‘ï¼Œæ‰§è¡Œåˆ° next()å‡½æ•°åä¼šæ‰§è¡Œç¬¬äºŒä¸ªä¸­é—´ä»¶çš„é€»è¾‘ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªä¸­é—´ä»¶ã€‚å½“æœ€åä¸€ä¸ªä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè·³å›æ‰§è¡Œå€’æ•°ç¬¬äºŒä¸ªä¸­é—´ä»¶ next()å‡½æ•°åé¢çš„ä»£ç ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ next()å‡½æ•°åé¢çš„ä»£ç æ‰§è¡Œå®Œæ¯•ã€?

![æ´‹è‘±æ¨¡å‹](http://www.shadowingszy.top/images/koa.png)

ä¸¾ä¾‹æ¥è¯´ï¼?

```javascript
const Koa = require('koa')

const app = new Koa()
const PORT = 3000

// #1
app.use(async (ctx, next) => {
  console.log(1)
  await next()
  console.log(1)
})
// #2
app.use(async (ctx, next) => {
  console.log(2)
  await next()
  console.log(2)
})

app.use(async (ctx, next) => {
  console.log(3)
})

app.listen(PORT)
console.log(`http://localhost:${PORT}`)
```

è®¿é—® http://localhost:3000ï¼Œæ§åˆ¶å°æ‰“å°ï¼?

```
1
2
3
2
1
```
